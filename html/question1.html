<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Math blockly Sample activity 1</title>
  <script src="../blockly/blockly_uncompressed.js"></script>
  <script src="../blockly/blocks/math.js"></script>
  <script src="../blockly/msg/js/en.js"></script>
  <script src="../blockly-type-indicator/typeIndicator.js"></script> <!-- indicate matching slots when dragging block !-->
  <script src="../js/shaped-connectors.js"></script>  <!-- Different shaped connectors according to type !-->

    <!--<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>!-->
  <script type="text/javascript" src="../MathJax/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <script src="../js/math-blocks.js"></script>  <!-- Load custom blocks !-->
  <script src="../js/math-blocks-q1.js"></script>  <!-- Load custom blocks !-->
  <script>
  /* Don't want to load in jQuery for now... so some quick convenience functions */
  /* Should probably use Google Closure library functions for this. */
  /* Set content of element 'id' to 'text' */
  function setContentById( id, text )
  {
    var e = document.getElementById( id );
    if( e ) {
      e.innerHTML = "";
      e.appendChild( document.createTextNode( text ) );
    }
  }

  function displayXML() {
    var xml = Blockly.Xml.workspaceToDom(workspace);
    var xml_text = Blockly.Xml.domToPrettyText(xml);
    setContentById( 'xml-output', xml_text );
    goog.dom.getElement( 'xml-output' ).style.display = "block";
  }
  
  function clearXML() {
    setContentById( 'xml-output', "" );
    goog.dom.getElement( 'xml-output' ).style.display = "none";  
  }
  
  goog.require( "goog.dom" );
  /* Recursively remove 'x' and 'y' attributes */
  function clearDisplayAttributes( node ) {
    var iterator = new goog.dom.NodeIterator( node );
    var next;
    try {
      while( next = iterator.next() ) {
        next.removeAttribute( "x" );
        next.removeAttribute( "y" );
      }
    } catch(e) {}
    return( node );
  }
  
  function checkAnswer() {
    var answerText = Blockly.Xml.domToText( document.getElementById( "solution" ).firstChild );
    answerText = answerText.replace(/[ \n]/g,'')
    console.log( "Answer:\n" + answerText );
    var responseXML = Blockly.Xml.workspaceToDom( workspace );
    responseXML = clearDisplayAttributes( responseXML );
    var responseText = Blockly.Xml.domToText( responseXML );
    responseText = responseText.replace(/[ \n]/g,'')
    console.log( "Response:\n" + responseText );
    if( answerText == responseText ) {
      goog.dom.getElement( "resultCorrect" ).style.display = "inline";
      goog.dom.getElement( "resultIncorrect" ).style.display = "none";
    } else {
      goog.dom.getElement( "resultCorrect" ).style.display = "none";
      goog.dom.getElement( "resultIncorrect" ).style.display = "inline";
    }
  }
  
  function cheat() {
    workspace.clear();
    Blockly.Xml.domToWorkspace(workspace,goog.dom.getElement('solution').firstChild);
  }
  
  </script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    /* Hide block highlight SVG elements while hacking */
    .blocklyPathLight {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Sample online questions</h1>

  <div>Use the blocks provided to give the definition of \(\displaystyle \lim_{n\to\infty} f(n) = L \).</div>
  <div id="blocklyDiv" style="height: 400px; width: 100%;"></div>
  
  <!--<input type="button" value="Check answer" onclick="checkAnswer();"/>!-->
  
  <a href="#" onclick="cheat();" style="float: right;">(cheat)</a>
  <div style="text-align: center;">
    <span id="resultIncorrect" style="color: red; display: none;">Not quite there yet...</span>
    <span id="resultCorrect" style="color: #00aa00; text-weight: bold; font-size: x-large; display: none;">Correct!</span>
  </div>

  <div id="xml-container">
   <input type="button" value="Display XML output" onclick="displayXML();"/><input type="button" value="Clear" onclick="clearXML();"/>
   <textarea id="xml-output" style="display: none; width: 100%; height: 200px;"></textarea>
  </div>

  <!--
  <xml id="toolbox" style="display: none">
    <block type="logic_forall_restricted"></block>
    <block type="logic_forall_condition_restricted"></block>
    <block type="logic_exists_restricted"></block>
    <block type="logic_exists_condition_restricted"></block>
    <block type="set_dropdown"></block>
    <block type="number_variable_restricted"></block>
    <block type="function_fn"></block>
    <block type="number_abs"></block>
    <block type="math_arithmetic"></block>
    <block type="number_comparison"></block>
  </xml>
  !-->  
  <xml id="workspace-initial" style="display: none;">
    <block type="logic_forall_condition_restricted" x="120" y="211">
      <field name="VAR">BLANK</field>
      <field name="COMPARISON_OPERATOR">&gt;</field>
      <field name="BOUND">BLANK</field>
    </block>
    <block type="logic_forall_condition_restricted" x="349" y="210">
      <field name="VAR">BLANK</field>
      <field name="COMPARISON_OPERATOR">&gt;</field>
      <field name="BOUND">BLANK</field>
    </block>
    <block type="logic_exists_restricted" x="616" y="214">
      <field name="VAR">BLANK</field>
      <field name="SET">REAL</field>
    </block>
    <block type="number_comparison" x="144" y="295">
      <field name="COMPARISON_OPERATOR">&lt;</field>
    </block>
    <block type="math_arithmetic" x="334" y="295">
      <field name="OP">ADD</field>
    </block>
    <block type="number_abs" x="530" y="294"></block>
    <block type="function_fn" x="661" y="298"></block>
    <block type="number_variable_restricted" x="720" y="300">
      <field name="VAR">BLANK</field>
    </block>
    <block type="number_variable_restricted" x="780" y="300">
      <field name="VAR">BLANK</field>
    </block>
  </xml>

  <script>
    var workspace = Blockly.inject('blocklyDiv',
        {
          media: 'blockly/media/',
          disable: false,
          toggleInline: false
        });

    Blockly.Xml.domToWorkspace( workspace, document.getElementById("workspace-initial") );
    
    var gChangeListener = workspace.addChangeListener( checkAnswer );
  </script>
  
  <div id="solution" style="display: none;"><xml>
      <block type="logic_forall_condition_restricted">
        <field name="VAR">epsilon</field>
        <field name="COMPARISON_OPERATOR">&gt;</field>
        <field name="BOUND">0</field>
        <value name="PREDICATE">
          <block type="logic_exists_restricted">
            <field name="VAR">M</field>
            <field name="SET">NATURALS</field>
            <value name="PREDICATE">
              <block type="logic_forall_condition_restricted">
                <field name="VAR">n</field>
                <field name="COMPARISON_OPERATOR">&gt;</field>
                <field name="BOUND">M</field>
                <value name="PREDICATE">
                  <block type="number_comparison">
                    <field name="COMPARISON_OPERATOR">&lt;</field>
                    <value name="LEFTINPUT">
                      <block type="number_abs">
                        <value name="INPUT">
                          <block type="math_arithmetic">
                            <field name="OP">MINUS</field>
                            <value name="A">
                              <block type="function_fn"></block>
                            </value>
                            <value name="B">
                              <block type="number_variable_restricted">
                                <field name="VAR">L</field>
                              </block>
                            </value>
                          </block>
                        </value>
                      </block>
                    </value>
                    <value name="RIGHTINPUT">
                      <block type="number_variable_restricted">
                        <field name="VAR">epsilon</field>
                      </block>
                    </value>
                  </block>
                </value>
              </block>
            </value>
          </block>
        </value>
      </block>
    </xml>
  </div>

</body>
</html>

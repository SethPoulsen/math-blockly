<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly mathematical expression builder</title>
  <script src="../blockly/blockly_uncompressed.js"></script>
<!--  <script src="../blockly/blocks_compressed.js"></script>!-->
  <script src="../blockly/blocks/math.js"></script>
  <script src="../blockly/msg/js/en.js"></script>
  <script src="../blockly-type-indicator/typeIndicator.js"></script> <!-- indicate matching slots when dragging block !-->
  <script src="../js/shaped-connectors.js"></script>  <!-- Different shaped connectors according to type !-->
  
  <script src="../js/math-blocks.js"></script>  <!-- Load custom blocks !-->
  <script src="../js/latex-generator.js"></script>
  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!--<script type="text/javascript" src="../MathJax/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>!-->
  <script>
  /* Configure MathJax */
  /* Without the "?config=" parameter above, this configuration causes an "TypeError: d[0] is not defined"!? Need to load in an extra config js file? */
/*  MathJax.Hub.Config({
    config: ["MMLorHTML.js"],
    jax: ["input/TeX","output/HTML-CSS","output/NativeMML", "output/CommonHTML"],
    extensions: ["tex2jax.js","MathMenu.js","MathZoom.js", "CHTML-preview.js"],
    TeX: {
      extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
    }
  });
*/
  </script>
  <script>
  goog.require( 'goog.net.XhrIo' );
  
  /* Set content of element 'id' to 'text' */
  function setContentById( id, text )
  {
    var e = document.getElementById( id );
    if( e ) {
      e.innerHTML = "";
      e.appendChild( document.createTextNode( text ) );
    }
  }
  
  function loadBlock() {
    var node = goog.dom.getElement( "load-dropdown" );
    var replace = goog.dom.getElement( "load-replace" ).checked;
    var selection = node.selectedOptions[0] && node.selectedOptions[0].value;
    if( selection && selection != "" ) {
      var url = "block-xml/" + selection + ".xml";
//      console.log( "Getting " + url );
      goog.net.XhrIo.send(url, function(e) {
        if( this.isSuccess() ) {
          var response = e.target.getResponseText();
  //          console.log( "Got XML data: %o", response );
          var dom = Blockly.Xml.textToDom( response );
          if( replace ) workspace.clear();
          Blockly.Xml.domToWorkspace( workspace, dom );
        } else {
          console.log( "Error loading block '" + selection + "': " + this.getLastError() );
        }
      });
    }
  }
  
  var gPreviousLatex;
  function displayLatex() {
    var code = Blockly.Latex.workspaceToCode( workspace );
    if( code != gPreviousLatex ) {
      setContentById( 'latex-output', code );
      setContentById( 'mathjax-output', "\\( " + code + " \\)" );
      MathJax.Hub.Queue(["Typeset",MathJax.Hub,"mathjax-output"]);
      gPreviousLatex = code;
    }
  }
  
  var gChangeListener;
  function setAutoLatex() {
    var s = goog.dom.getElement( "autolatex" ).checked;
    if( s ) {
      gChangeListener = workspace.addChangeListener( displayLatex );
      goog.dom.getElement( "updatelatex" ).style.display = "none";
      displayLatex();
    } else {
      if( gChangeListener ) {
        workspace.removeChangeListener( gChangeListener );
      }
      goog.dom.getElement( "updatelatex" ).style.display = "inline";
    }
  }
  
  function displayXML() {
    var xml = Blockly.Xml.workspaceToDom(workspace);
    var xml_text = Blockly.Xml.domToPrettyText(xml);
    setContentById( 'xml-output', xml_text );
    goog.dom.getElement( 'xml-output' ).style.display = "block";
  }
  
  function clearXML() {
    setContentById( 'xml-output', "" );
    goog.dom.getElement( 'xml-output' ).style.display = "none";  
  }
  </script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    /* Hide block highlight SVG elements while hacking */
    .blocklyPathLight {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Visual Mathematical Expression Builder</h1>

  <p>This is a test of a visual mathematical expression builder using <a href="https://developers.google.com/blockly/">Blockly</a></p>
  
  <div>Load:
   <select id="load-dropdown">
    <option value="" selected>-- choose one --</option>
    <option value="sequence-limit">Limit of a sequence</option>
    <option value="function-limit">Limit of a function</option>
    <option value="divisibility">_ is divisible by _</option>
    <option value="prime">p is prime</option>
   </select>
   <button onclick="loadBlock();">Load</button>
   <input type="checkbox" id="load-replace" checked="false"/>Replace existing blocks

  <div id="blocklyDiv" style="height: 400px; width: 100%;"></div>
  
  <div id="latex-container">
   <input type="checkbox" id="autolatex" checked="false" onchange="setAutoLatex();"/>Auto-update latex
   <input type="button" id="updatelatex" value="Update Latex output" onclick="displayLatex();" style="display: none;"/>
   <div id="mathjax-output" style="text-align: center;"></div>
   <pre id="latex-output" style="display: block; text-align: center;"></pre>
  </div>
  
  <div id="xml-container">
   <input type="button" value="Display XML output" onclick="displayXML();"/><input type="button" value="Clear" onclick="clearXML();"/>
   <textarea id="xml-output" style="display: none; width: 100%; height: 200px;"></textarea>
  </div>

  <xml id="toolbox" style="display: none">
    <!-- Logic blocks !-->
    <category name="Logic">
<!--
      <block type="logic_forall"></block>
      <block type="logic_forall_condition"></block>
      <block type="logic_exists"></block>
      <block type="logic_exists_condition"></block>
!-->
      <block type="logic_quantifier"></block>
      <block type="logic_connective"></block>
      <block type="logic_negation"></block>
      <block type="logic_prop_variable"></block>
    </category>

    <!-- Number blocks !-->
    <category name="Number">
      <block type="number_variable"></block>
      <block type="number_comparison"></block>
      <block type="math_arithmetic"></block>  <!-- Blockly standard block !-->
      <block type="math_number"></block>      <!-- Blockly standard block !-->
      <block type="number_0"></block>
      <block type="number_1"></block>
      <block type="number_pi"></block>
      <block type="number_e"></block>
      <block type="number_add_inv"></block>
      <block type="number_mult_inv"></block>
    </category>

    <!-- Function blocks !-->
    <category name="Functions">
      <block type="number_abs"></block>
      <block type="number_trig_functions"></block>
      <block type="number_log_function"></block>
      <block type="function_variable"></block>
      <!-- TODO !-->
    </category>


    <!-- Set blocks !-->
    <category name="Sets">
      <block type="set_r"></block>
      <block type="set_q"></block>
      <block type="set_z"></block>
      <block type="set_n"></block>
      <block type="set_nullset"></block>
      <block type="set_variable"></block>
      <block type="set_membership"></block>
      <block type="set_operations"></block>
      <block type="set_complement"></block>
      <block type="set_comparison"></block>
      <block type="set_bounds"></block>
    </category>
    
    <!-- Built-in variables category !-->
    <!--<category name="Variables" custom="VARIABLE"></category>!-->
  </xml>

  <script>
    var workspace = Blockly.inject('blocklyDiv',
        {
          media: '../blockly/media/',
          toolbox: document.getElementById('toolbox'),
          zoom: {controls: true, wheel: true},
          disable: false,
          toggleInline: false
        });
     setAutoLatex();
  </script>

</body>
</html>
